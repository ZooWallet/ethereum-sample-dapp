<html>
    <head>
        <title>Ethereum Sample Dapp</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    </head>
    <body>
        <div class="container">
            <nav class="navbar navbar-light bg-light">
                <a class="navbar-brand" href="/">
                    <span class="navbar-brand mb-0 h1">Ethereum Sample Dapp</span>
                </a>
                <div class="my-2 my-sm-0">
                    <button class="btn btn-primary" id="login_button" type="button" data-toggle="tooltip" data-placement="bottom" title="window.ethereum.enable()">
                        Login
                    </button>
                    <button class="btn btn-success" id="login_button_new" type="button" data-toggle="tooltip" data-placement="bottom" title="ethereum.request({ method: 'eth_requestAccounts' })">
                        Login New
                    </button>
                    <!-- <button class="btn btn-outline-danger" id="logout_button" type="button">Logout (Wallet Connect)</button> -->
                </div>
            </nav>
            <div class="card">
                <div class="card-header">
                    Provider and web3
                </div>
                <div class="card-group">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">window.ethereum</h5>
                            <span id='window_ethereum'>---</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">window.ethereum.isMetaMask</h5>
                            <span id='is_metamask'>---</span>
                        </div>
                    </div>
                </div>
                <div class="card-group">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">window.web3</h5>
                            <span id="window_web3">---</span>
                            <span id='window_web3_version'></span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">window.web3.currentProvider</h5>
                            <span id='window_web3_currentProvider'>---</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">web3</h5>
                            <span id='web3_instance'>---</span>
                            <span id='web3_version'></span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">web3.currentProvider</h5>
                            <span id="web3_currentProvider">---</span>
                        </div>
                    </div>
                </div>
            </div>
            <br />
            <div class="card">
                <div class="card-header">
                    Get Account and Network
                </div>
                <div class="card-group">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Return Account</h5>
                            <span id='return_account'>---</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">ethereum.request({ method: 'eth_accounts' })</h5>
                            <span id='ethereum_request_account'>---</span>
                        </div>
                    </div>
                </div>
                <div class="card-group">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">web3.eth.defaultAccount</h5>
                            <span id='web3_defaultAccount'>---</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">web3.eth.getAccounts()</h5>
                            <span id='web3_accounts'>---</span>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">web3.eth.getCoinbase()</h5>
                            <span id='web3_coinbase'>---</span>
                        </div>
                    </div>
                </div>
                <div class="card-group">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">web3.version.getNetwork()</h5>
                            <!-- <span id='web3_netType'>---</span> -->
                            <span id='web3_netId'>---</span>
                        </div>
                    </div>
                </div>
            </div>
            <br />
            <div class="card-deck">
                <div class="card">
                    <div class="card-header">Sign Message</div>
                    <div class="card-body">
                        <h5 class="card-title">web3.eth.sign()</h5>
                        <div class="input-group mb-3">
                            <input
                                id="sign_input"
                                type="text"
                                class="form-control"
                                placeholder="message"
                                aria-label="message"
                                aria-describedby="web3_sign_button">
                            <div class="input-group-append">
                            <button class="btn btn-primary" type="button" id="web3_sign_button">Sign</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <span>Sign Result: </span>
                        <span id='web3_sign_result'></span>                        
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Sign Message</div>
                    <div class="card-body">
                        <h5 class="card-title">ethereum.request({ method: 'eth_sign' })</h5>
                        <div class="input-group mb-3">
                            <input
                                id="personal_sign_input"
                                type="text"
                                class="form-control"
                                placeholder="message"
                                aria-label="message"
                                aria-describedby="web3_personal_sign_button">
                            <div class="input-group-append">
                                <button class="btn btn-primary" type="button" id="web3_personal_sign_button">Sign</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <span>Sign Result: </span>
                        <span id='web3_personal_sign_result'></span>
                    </div>
                </div>
            </div>
            <br>
            <div class="card-deck">
                <div class="card">
                    <div class="card-header">Send Transaction</div>
                    <div class="card-body">
                        <h5 class="card-title">web3.eth.sendTransaction()</h5>
                        <textarea class="form-control mb-3" aria-label="With textarea" id="web3_send_tx_address" placeholder="Destination ETH address"></textarea>
                        <div class="input-group mb-3">
                            <input
                                id="web3_send_tx_amount"
                                type="text"
                                class="form-control"
                                placeholder="ETH send amount"
                                aria-label="ETH send amount"
                                aria-describedby="web3_send_tx_button">
                            <div class="input-group-append">
                                <button
                                    class="btn btn-primary"
                                    type="button"
                                    id="web3_send_tx_button">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <span>Transaction Hash: </span>
                        <span id='web3_tx_hash'></span>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">Send Transaction</div>
                    <div class="card-body">
                        <h5 class="card-title">ethereum.request({ method: 'eth_sendTransaction' })</h5>
                        <textarea class="form-control mb-3" aria-label="With textarea" id="ethereum_send_tx_address" placeholder="Destination ETH address"></textarea>
                        <div class="input-group mb-3">
                            <input
                                id="ethereum_send_tx_amount"
                                type="text"
                                class="form-control"
                                placeholder="ETH send amount"
                                aria-label="ETH send amount"
                                aria-describedby="ethereum_send_tx_button">
                            <div class="input-group-append">
                                <button
                                    class="btn btn-primary"
                                    type="button"
                                    id="ethereum_send_tx_button">
                                    Send
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer text-muted">
                        <span>Transaction Hash: </span>
                        <span id='ethereum_tx_hash'></span>
                    </div>
                </div>
            </div>
            <blockquote class="blockquote text-center my-4">
                <p class="mb-0">Build things on Ethereum is an extreme exercise.</p>
                <footer class="blockquote-footer">
                    <p>
                        <span>Buidl with &#128154; by</span>
                        <a href="https://www.dapppocket.io/">Dapp Pocket</a>
                    </p>
                </footer>
            </blockquote>
        </div>
    </body>
</html>

<script
    src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous">
</script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"
    integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ"
    crossorigin="anonymous">
</script>
<script
    src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"
    integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm"
    crossorigin="anonymous">
</script>
<script src="/static/ethers.js"></script>

<script>
// Enable tooltip
$(function () {
  $('[data-toggle="tooltip"]').tooltip()
})

let myAccount = '';

// Get provider and web3
if(window.ethereum) {
    $("#window_ethereum").html('TRUE').addClass('badge badge-primary');
} else {
    $("#window_ethereum").html('FALSE').addClass('badge badge-danger');
};
if(window.ethereum.isMetaMask) {
    $("#is_metamask").html('TRUE').addClass('badge badge-primary');
} else {
    $("#is_metamask").html('FALSE').addClass('badge badge-danger');
}
if(window.web3) {
    $("#window_web3").html('TRUE').addClass('badge badge-primary');
    $('#window_web3_version').html(`v${window.web3.version.api}`);
} else {
    $("#window_web3").html('FALSE').addClass('badge badge-danger');
};
if(window.web3.currentProvider) {
    $("#window_web3_currentProvider").html('TRUE').addClass('badge badge-primary');
} else {
    $("#window_web3_currentProvider").html('FALSE').addClass('badge badge-danger');
};
if(web3) {
    $("#web3_instance").html('TRUE').addClass('badge badge-primary');
    $('#web3_version').html(`v${web3.version.api}`);
} else {
    $("#web3_instance").html('FALSE').addClass('badge badge-danger');
};
if(web3.currentProvider) {
    $("#web3_currentProvider").html('TRUE').addClass('badge badge-primary');
} else {
    $("#web3_currentProvider").html('FALSE').addClass('badge badge-danger');
};

// Web3 Login
$("#login_button").click(() => {
    window.ethereum.enable().then((accounts) => {
        $("#login_button").html('Login Succeed').addClass('disabled');

        $('#return_account').html(accounts[0]);
        myAccount = accounts[0];

        getAccountAndNetwork();
    }).catch((e) => {
        // alert('No wallet detected!');
        console.error(e);
    });
});

$("#login_button_new").click(() => {
    ethereum.request({ method: 'eth_requestAccounts' })
    .then((accounts) => {
        $("#login_button_new").html('Login Succeed').addClass('disabled');

        $('#return_account').html(accounts[0]);
        myAccount = accounts[0];

        getAccountAndNetwork();
    }).catch((e) => {
        // alert('No wallet detected!');
        console.error(e);
    });
});

$("#logout_button").click(() => {
    if(!(typeof window.ethereum.logout === 'function')) {
        alert('Please use wallet connect.');
    } else {
        window.ethereum.logout().then((res) => {
            console.log('logout done. res: ', res);
        }).catch((err) => {
            alert(err);
        });
    }
});

// Web3 Sign
$("#web3_sign_button").click(() => {
    const signMessage = $('#sign_input').val();
    if(!myAccount) {
        alert("Please login first!");
    } else {
        web3.eth.sign(myAccount, web3.sha3(signMessage), (err, result) => {
            if(err) {
                alert(err.message);
            }
            $('#web3_sign_result').html(result);
        });
    }
});

// Ethereum eth_sign
$("#web3_personal_sign_button").click(() => {
    const message = $('#personal_sign_input').val();
    if(!myAccount) {
        alert("Please login first!");
    } else {
        ethereum.request({ method: 'eth_sign', params: [myAccount, web3.sha3(message)] })
        .then((result) => {
            $('#web3_personal_sign_result').html(result);
        })
        .catch((e) => {
            alert(e.message);
        });
    }
});

// Web3 Send Transaction
$("#web3_send_tx_button").click(() => {
    const recipient = $('#web3_send_tx_address').val();
    const sendAmount = $('#web3_send_tx_amount').val();
    const WEI = 1000000000000000000;
    const transactionObject = {
        from: myAccount,
        to: recipient,
        value: (sendAmount * WEI).toString(),
        gas: 21000,
    };
    if(!myAccount) {
        alert("Please login first!");
    } else {
        web3.eth.sendTransaction(transactionObject, (e, result) => {
            if(e) {
                alert(e.message);
            };
            $('#web3_tx_hash').html(result);
        });
    }
});

// Ethereum Send Transaction
$("#ethereum_send_tx_button").click(() => {
    const recipient = $('#ethereum_send_tx_address').val();
    const sendAmount = $('#ethereum_send_tx_amount').val();
    const WEI = 1000000000000000000;
    const transactionObject = {
        from: myAccount,
        to: recipient,
        value: ethers.utils.hexValue(sendAmount * WEI),
        gas: '21000',
    };
    if(!myAccount) {
        alert("Please login first!");
    } else {
        ethereum.request({ method: 'eth_sendTransaction', params: [transactionObject] })
        .then((result) => {
            $('#ethereum_tx_hash').html(result);
        })
        .catch((e) => {
            alert(e.message);
        });
    }
});

const getAccountAndNetwork = function() {
    $("#web3_defaultAccount").html(web3.eth.defaultAccount);

    web3.eth.getCoinbase((err, account) => {
        $('#web3_coinbase').html(account);
    })

    web3.eth.getAccounts((err, accounts) => {
        $('#web3_accounts').html(accounts);
    })

    web3.version.getNetwork((err, id) => {
        $("#web3_netId").html(id);
    })

    ethereum.request({ method: 'eth_accounts' })
    .then((accounts) => {
        $("#ethereum_request_account").html(accounts[0]);
    });
};

</script>
